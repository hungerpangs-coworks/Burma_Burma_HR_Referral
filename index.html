<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Refer a Buddy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Basic SEO -->
  <meta name="description"
        content="Submit employee referrals for Burma Burma Restaurant & Tea Room through a simple HR referral portal integrated with Google Sheets." />
  <meta name="robots" content="index, follow" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="BB_Logo_favicon.png" sizes="512x512">
  <link rel="icon" type="image/png" href="BB_Logo_favicon.png" sizes="256x256">
  <link rel="icon" type="image/png" href="BB_Logo_favicon.png" sizes="128x128">
  <link rel="icon" type="image/png" href="BB_Logo_favicon.png" sizes="32x32">
  <link rel="apple-touch-icon" href="BB_Logo_favicon.png">

  <!-- Open Graph / Twitter (optional but nice) -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="Burma Burma | Employee Referral" />
  <meta property="og:description"
        content="A quick and easy way for Burma Burma employees to submit referrals directly to HR." />
  <meta property="og:url"
        content="https://hungerpangs-coworks.github.io/Burma_Burma_HR_Referral/" />
  <meta property="og:image"
        content="https://hungerpangs-coworks.github.io/Burma_Burma_HR_Referral/BB_Logo_favicon.png" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Burma Burma | Employee Referral" />
  <meta name="twitter:description"
        content="Submit employee referrals quickly with this internal HR portal." />
  <meta name="twitter:image"
        content="https://hungerpangs-coworks.github.io/Burma_Burma_HR_Referral/BB_Logo_favicon.png" />

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: radial-gradient(circle at top, #ffffff 0, #f3f6fb 45%, #e5edf7 100%);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .bb-logo {
      width: 120px;
      height: auto;
      filter: drop-shadow(0 4px 10px rgba(15, 23, 42, 0.3));
    }

    .page-title {
      font-weight: 800;
      font-size: 2.25rem;
      color: #1d4ed8;
    }

    .page-subtitle {
      color: #6b7280;
      font-size: 0.95rem;
    }

    .card-referral {
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
    }

    .form-label {
      font-size: 0.9rem;
      font-weight: 500;
      color: #111827;
    }

    .form-control,
    .form-select {
      border-radius: 0.75rem;
      border-color: #e5e7eb;
      background-color: #f9fafb;
      font-size: 0.9rem;
      padding: 0.65rem 0.9rem;
    }

    .form-control:focus,
    .form-select:focus,
    textarea:focus {
      border-color: #1d9bf0;
      box-shadow: 0 0 0 0.15rem rgba(29, 155, 240, 0.35);
      background-color: #ffffff;
    }

    .btn-gradient {
      background: linear-gradient(to right, #1d9bf0, #34d399);
      border: none;
      color: #ffffff;
      font-weight: 600;
      border-radius: 999px;
      padding: 0.7rem 1.6rem;
      box-shadow: 0 12px 30px rgba(37, 99, 235, 0.3);
    }

    .btn-gradient:hover {
      box-shadow: 0 14px 36px rgba(37, 99, 235, 0.35);
      transform: translateY(-1px);
    }

    .section-heading {
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #6b7280;
      margin-bottom: 4px;
    }

    .status-text {
      font-size: 0.85rem;
    }

    @media (max-width: 576px) {
      .btn-group-flex {
        flex-direction: column;
      }
      .btn-group-flex > * {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container py-4 py-md-5">
    <div class="row justify-content-center">
      <div class="col-lg-9">
        <!-- Header -->
        <div class="text-center mb-4">
          <img src="BB_Logo_favicon.png" alt="Burma Burma Logo" class="bb-logo mb-2" />
          <div class="page-title">Refer a Buddy</div>
          <div class="page-subtitle">
            Refer great talent to the Burma Burma family in just a few clicks.
          </div>
        </div>

        <!-- Card -->
        <div class="card card-referral">
          <div class="card-body p-4 p-md-5">

            <!-- ALERTS -->
            <div id="alert-container" class="mb-3" style="display:none;">
              <div id="alert" class="alert mb-0" role="alert"></div>
            </div>

            <!-- FORM -->
            <div id="formSection">
              <!-- YOUR DETAILS -->
              <div class="section-heading">Your details</div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label for="employeeId" class="form-label">Employee ID <span class="text-danger">*</span></label>
                  <input
                    type="text"
                    id="employeeId"
                    class="form-control"
                    placeholder="Enter your employee ID"
                  />
                </div>
                <div class="col-md-6">
                  <label for="employeeName" class="form-label">Employee Name <span class="text-danger">*</span></label>
                  <input
                    type="text"
                    id="employeeName"
                    class="form-control"
                    placeholder="Enter your full name"
                  />
                </div>
                <div class="col-md-6">
                  <label for="outletName" class="form-label">Outlet Name <span class="text-danger">*</span></label>
                  <select id="outletName" class="form-select">
                    <option value="">Select outlet</option>
                  </select>
                </div>
              </div>

              <!-- REFERRAL DETAILS (candidate side) -->
              <div class="section-heading mt-3">Referral details</div>
              <div class="row g-3 mb-3">
                <div class="col-md-6">
                  <label for="refDept" class="form-label">Referred in Department <span class="text-danger">*</span></label>
                  <select id="refDept" class="form-select">
                    <option value="">Select department</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="refDesig" class="form-label">Referred for Designation <span class="text-danger">*</span></label>
                  <select id="refDesig" class="form-select">
                    <option value="">Select designation</option>
                  </select>
                </div>

                <div class="col-md-6">
                  <label for="cvFile" class="form-label">Upload CV <span class="text-danger">*</span></label>
                  <input
                    type="file"
                    id="cvFile"
                    class="form-control"
                    accept=".pdf,.doc,.docx,.rtf,.txt"
                  />
                  <small class="text-muted">Attach the candidate's latest CV.</small>
                </div>

                <div class="col-md-12">
                  <label for="remarks" class="form-label">Remarks (optional)</label>
                  <textarea
                    id="remarks"
                    class="form-control"
                    rows="3"
                    placeholder="Share anything helpful about the person youâ€™re referring."
                  ></textarea>
                </div>
              </div>

              <!-- ACTIONS -->
              <div class="d-flex justify-content-between align-items-center mt-4 btn-group-flex">
                <div id="statusText" class="status-text text-muted"></div>
                <button type="button" class="btn btn-gradient" id="submitBtn">
                  Submit Referral
                </button>
              </div>
            </div>

            <!-- THANK YOU SECTION (optional â€“ currently unused) -->
            <div id="thankYouSection" class="text-center" style="display:none;">
              <h4 class="mb-1">Thank you!</h4>
              <p class="text-muted mb-3">
                Your referral has been submitted to HR.
              </p>
              <button type="button" class="btn btn-gradient mt-2" id="btnNewReferral">
                Submit another referral
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    // ðŸ”´ Your web app URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxIiJkv_m0RA3NnrI6uSiJzoy0GLLA1CX5RLauOnoq2fqSwsIKu_UXEPydrnC3cd6DuYg/exec';

    const outletSelect = document.getElementById('outletName');
    const deptSelect   = document.getElementById('refDept');
    const desigSelect  = document.getElementById('refDesig');
    const statusText   = document.getElementById('statusText');
    const submitBtn    = document.getElementById('submitBtn');
    const alertContainer = document.getElementById('alert-container');
    const alertBox       = document.getElementById('alert');
    const formSection    = document.getElementById('formSection');
    const thankYouSection = document.getElementById('thankYouSection');
    const btnNewReferral = document.getElementById('btnNewReferral');

    let deptDesigMap = {}; // dept -> [designations]

    function showAlert(message, type = 'danger') {
      alertBox.className = 'alert alert-' + type + ' mb-0';
      alertBox.textContent = message;
      alertContainer.style.display = 'block';
    }

    function clearAlert() {
      alertContainer.style.display = 'none';
      alertBox.textContent = '';
    }

    function setStatus(msg, type) {
      statusText.textContent = msg || '';
      if (!msg) return;
      statusText.classList.remove('text-success', 'text-danger', 'text-muted');
      if (type === 'success') statusText.classList.add('text-success');
      else if (type === 'error') statusText.classList.add('text-danger');
      else statusText.classList.add('text-muted');
    }

    function fillSelect(selectEl, items, placeholder) {
      selectEl.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = placeholder;
      selectEl.appendChild(opt0);

      (items || []).forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
    }

    function updateDesignationOptionsForDept(dept) {
      const list = deptDesigMap[dept] || [];
      fillSelect(desigSelect, list, 'Select designation');
    }

    async function loadConfig() {
      try {
        setStatus('Loading options...', '');
        clearAlert();

        const res = await fetch(WEB_APP_URL + '?action=getConfig');
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to load config');

        const { outlets, departments, deptDesigMap: ddm } = data.data || {};
        deptDesigMap = ddm || {};

        fillSelect(outletSelect, outlets, 'Select outlet');
        fillSelect(deptSelect, departments, 'Select department');
        fillSelect(desigSelect, [], 'Select designation');

        setStatus('', '');
      } catch (err) {
        console.error(err);
        showAlert('Error loading options: ' + err.message, 'danger');
        setStatus('Error loading options', 'error');
      }
    }

    deptSelect.addEventListener('change', () => {
      const dept = deptSelect.value.trim();
      updateDesignationOptionsForDept(dept);
      desigSelect.value = '';
    });

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        if (!file) return resolve(null);
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result || '';
          const parts = String(result).split(',');
          resolve(parts.length > 1 ? parts[1] : null);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handleSubmit() {
      try {
        clearAlert();
        setStatus('', '');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        const employeeId   = document.getElementById('employeeId').value.trim();
        const employeeName = document.getElementById('employeeName').value.trim();
        const outletName   = outletSelect.value.trim();
        const referringDept = deptSelect.value.trim();      // candidate dept
        const referringDesig = desigSelect.value.trim();    // candidate role
        const remarks      = document.getElementById('remarks').value.trim();
        const cvFile       = document.getElementById('cvFile').files[0] || null;

        if (!employeeId || !employeeName || !outletName || !referringDept || !referringDesig) {
          throw new Error('Please fill all required fields (*)');
        }
        if (!cvFile) {
          throw new Error('Please upload the candidate\'s CV.');
        }

        const base64 = await fileToBase64(cvFile);
        const cvPayload = {
          fileName: cvFile.name,
          mimeType: cvFile.type || 'application/octet-stream',
          base64: base64
        };

        const payload = {
          employeeId,
          employeeName,
          outletName,
          referringDept,               // stored as Referring Dept in sheet (candidate dept)
          referringDesignation: referringDesig,
          remarks,
          cv: cvPayload
        };

        const formData = new FormData();
        formData.append('payload', JSON.stringify({
          action: 'submitReferral',
          payload
        }));

        const res = await fetch(WEB_APP_URL, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Failed to submit');

        setStatus('Referral submitted successfully ðŸŽ‰', 'success');

        // Clear form
        document.getElementById('employeeId').value = '';
        document.getElementById('employeeName').value = '';
        outletSelect.value = '';
        deptSelect.value = '';
        updateDesignationOptionsForDept('');
        document.getElementById('remarks').value = '';
        document.getElementById('cvFile').value = '';

        // (Optional) show thank you screen instead of just clearing
        // formSection.style.display = 'none';
        // thankYouSection.style.display = 'block';

      } catch (err) {
        console.error(err);
        showAlert(err.message || 'Something went wrong while submitting your referral.', 'danger');
        setStatus('Failed to submit', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Referral';
      }
    }

    submitBtn.addEventListener('click', evt => {
      evt.preventDefault();
      handleSubmit();
    });

    if (btnNewReferral) {
      btnNewReferral.addEventListener('click', () => {
        thankYouSection.style.display = 'none';
        formSection.style.display = 'block';
        clearAlert();
        setStatus('', '');
      });
    }

    // Initial load
    loadConfig();
  </script>
</body>
</html>
